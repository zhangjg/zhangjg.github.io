---
title: 如何写Makefile文件一
tags: [编程,日志 ]
---

如何写Makefile，可以写整整的一本书，最初的时候，我也是从[《GNU Make中文手册》](http://share.weiyun.com/5b07d161d682533442489a3d6fbbffd9)系统学习如何写Makefile文件的。很多时候，有些写Makefile的命令或变量，我也还需要从这本书中去查。现在我觉得，这本书是Makefile编写的工具书，我今天写这个博客，当然不是指望，自己能比这本书写的更好，如果你要系统的学习Makefile的编写，如果让我推荐书籍的话，我还是推荐这本书。我今天写博客，是为那些，打算做Linux下C语言开发，打算写用Makefile做自动化生成工具的的人，一个快速的入门，同时也说一下自己在使用make的时候遇到的一些坑。

现在自动化构建工具，已经有很多了，有的语言还不止一个，比如Java，最初的时候有ant，后来又有什么maven，现在安卓用的又是另外一个，各自的有自己的优缺点，各自也有自己的用武之地。不同语言的IDE（集成开发环境）其实都是在为一个特定的语言，为此一个自动化的构建工具。我见过不少的人，开发程序，十分的依赖IDE。使用IDE，可以提高开发的速度，可以提高代码的规范程度，这些都是使用IDE的好处，对初学者来说，其实我十分不建议使用IDE来作为开发的工具，因为IDE做的太多，初学者就不知道中间发生的过程了。比如C语言中，我想如果你没有自己动手一步一步的把源码编译一边，实际上是不理解，源码到可执行程序的编译过程是怎么来的。如果不自己写一个Makefile，就不会知道IDE是如何做到自动化构建的。

以上算是开场白。下面正式开始今天的介绍。

Makefile文件不好写，不仅仅是因为我们对make程序的特性了解的不够清楚，而是因为写好Makefile，需要的背景知识很多，很多时候，写不好Makefile未必是因为对Makefile的规则卡住的，更多的时候，是被那些我们使用Makefile的时候的背景知识给卡住的。比如，Makefile中的命令，很多时候就是Shell中的命令，如果对Shell不够熟悉那当然是不能写出如自己希望工作的Makefile的。Makefile，大部分是为C或C++项目写的，编译器使用的是GCC或者是其他的程序，有时候我们预期的效果是编译器的特点参数才能产生的，如果不了解编译器的这些特效，当让也没有办法写出如自己预期工作的Makefile。

今天是这个系列的第一篇，将一些最基础的东西。

首先第一个观念是，Makefile其实是一个解释性的语言，make程序是这个语言的解释器。不仅可以用Makefile来做C/C++的自动化构建程序，其实，只要你的外围的程序写的好，你可以用Makefile做很多事情。比如，为一个道菜做一个指导程序。

说Makefile是一个编程语言，可能会吓退很多初学者，本来我是为了减少手动编译的麻烦才学习Makefile的，现在好了，有得学习一门新的语言，这不自己给自己找不自在吗？不用担心，Makefile这个语言，和C语言，C++以及Java，Javascipt等等语言不一样，那些语言叫做通用编程语言，而Makefile相反，他是特定领域语言(DSL)[https://en.wikipedia.org/wiki/Domain-specific_language "Domain Speciac Language"]的一种。Makefile是特意为描述完成一个目标，需要的步骤而设计的语言。这个语言也只局限于这个目标，所以，这个语言设计的不复杂，学习的难度和C、C++等通用编程语言是没法比的。当时用这个语言来描述，完成一个目标的步骤，有时特别的容易和清楚。

好了，现在我们认定makefile是一个编程语言了，那么我们看看这个语言有哪些特性。
作为一个语言，首先有的应该就是变量了，Makefile中是支持变量的。Makefile中变量的用法和Shell中有几分像，但是有不全部一样。今天我们就只将Makefile中的变量，其他的问题，以后再说。

在Makefile中，像在Shell中一样，直接对变量赋值就定义的一个变量。
例如下面这样：

```Makefile
SRC= test.c test.h
$(info SRC=$(SRC))  #or $(info SRC=${SRC})
```

第一行，第一义了一个变量SRC，第二行，调用了一个Makefile的函数info展示类似这样的一个文本：`SRC= test.c test.h`。第二行中，`$(SRC)`被替换成了第一行中赋给`SRC`的值。

Makefile中定义变量的方式有好几种，应用变量的方式有两种，还有一种等效的写法，在第二行的注释中，也就是说`$`后用小括号或用大括号把变量名称括气来，都是对变量值的引用。我所以不推荐用大括号原因是，这种用法也是Shell中可行的变量引用的方法，如果这样用，就不容易区分是Makefile的代码还是Shell的代码，后面会看到，区分这两点有时候在写makefile的时候是很有必要的。

现在我们暂且把变量值的引用放下，来看看第一义变量的几种不同的方法。
+ 使用`=`定义变量
    ```makefile
    SRC= test.c test.h
    ```
    这个方法定义的变量，无论变量之前有没有值，现在的值都是赋值之后的值。
+ 使用`?=`对变量赋值
    ```makefile
    SRC ?= test.c test.h
    ```
    这样定义的变量，只有当SRC在这之前是没有定义的时候才能被赋值为现在定义的值。

+ 使用`:=`对变量赋值
    ```makefile
    SRC := test.c test.h
    ```
    这种方式定义的变量在变量展开的时候和前面的两种方式不一样，下面看到第四种的方法的时候，举例说明。
+ 对变量追加内容`+=`
    ```makefile
    SCR1 = test.c test.h
    SRC2 := test.c test.h
    SCR1 += SCR1
    SCR2 += SCR2
    $(info SCR1=$(SCR1)) #ouput "test.c test.h test.c test.h"
    $(info SCR2=$(SCR2)) #output
    ```
    也就是说试用`:=`定义的变量，在展开的时候，立即展开，而其他形式定义的变量延迟展开。
